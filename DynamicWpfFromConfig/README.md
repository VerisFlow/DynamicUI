# Dynamic WPF UI from JSON

## Overview

This is a WPF application whose core feature is the dynamic generation of its user interface entirely from JSON configuration files. It supports a plugin architecture for extensibility and includes built-in, flexible CSV data import/export capabilities.

This design makes it possible to completely change the application's appearance, layout, and functionality without recompiling the code.

## Core Features

* **JSON-Driven UI:** Window styles, layout (Grid rows/columns), controls and their properties, and themes are all defined by JSON files.
* **Plugin System:** Supports loading external `.dll` plugins from the `/plugins` directory to extend functionality and handle custom actions.
* **Dynamic Data Operations:**
    * Includes a flexible CSV data importer that supports dynamically getting parsing parameters (like delimiter, file path) from UI controls.
    * Supports querying and loading data into form controls.
    * Supports loading entire CSV files into a `DataGrid`.
    * Includes a flexible CSV data exporter, supporting the export of form data or selected rows from a `DataGrid`.
* **Composite Controls:** Includes custom-rendered controls like `TitrationPlate` and `PluginSurface`.
* **Events and Actions:** Supports binding "Actions" to controls (like buttons, checkboxes) within the JSON. These actions can be handled by the main window or routed to a specified plugin.

## Project Structure

To improve code readability and maintainability, the main `MainWindow` class has been split into multiple files using C#'s `partial class` keyword.

At compile time, these files are merged into a **single class**, allowing them to share all private fields and methods. This separation **does not change any program logic** and is purely for code organization and management.

Here is the breakdown of responsibilities for each `MainWindow` file:

* **`MainWindow.xaml`**
    * The WPF view file. It contains only a single root `Grid` named `DynamicControlsContainer`, where all dynamic controls are added.

* **`MainWindow.xaml.cs`**
    * **Core & Entry Point.**
    * Contains all private fields (e.g., `_uiConfig`, `_loadedPlugins`, `_themeBackgroundBrush`).
    * Contains the window constructor (`MainWindow()`).
    * Contains the window loaded event (`Window_Loaded`), which is the entry point for starting the UI build and plugin loading.
    * Contains the core UI loading and layout methods (`LoadConfigAndBuildUi`, `ApplyTheme`, `BuildGridLayout`).
    * Contains the plugin loading logic (`LoadPlugins`).

* **`MainWindow.Factory.cs`**
    * **UI Control Factory.**
    * Contains all code responsible for **creating** WPF controls.
    * `CreateControl(model)`: The core `switch` statement that creates a `FrameworkElement` based on a `ControlModel`.
    * `CreateImageElement`, `CreateTitrationPlateElement`, `CreateWellStyle`: Helper methods for creating complex controls.
    * `ApplyCommonProperties`: Applies common properties from the JSON (like Grid layout, margin, alignment) to the controls.
    * `GetLogForegroundBrush`: A helper method for color-coding logs in a `ListBox`.

* **`MainWindow.Events.cs`**
    * **UI Event Handlers.**
    * Contains all event handler methods that respond to user interaction.
    * `DynamicButton_Click`: Handles all dynamic button click events.
    * `DynamicEventHandler`: Handles other dynamic events, such as `CheckBox` `Checked`/`Unchecked`.
    * `HandleHostAction`: The central "Action Router" that executes built-in actions like `showmessage`, `togglevisibility`, `loadfiletoviewer`, etc.
    * `DataGrid_AutoGeneratedColumns`: The event handler used to apply column visibility states after a `DataGrid` auto-generates its columns.

* **`MainWindow.Data.cs`**
    * **Data Import/Export Service.**
    * Contains all logic related to reading from and writing to CSV files.
    * `LoadDataFromFile`: (Import) Loads a **single row** of data from a CSV into various UI controls.
    * `HandleLoadFileToViewer`: (Import) Loads an **entire** CSV file into a `DataGrid`.
    * `ExportDataToCsv`: (Export) Collects data from UI controls and exports it as a **single row** to a CSV.
    * `HandleExportGridSelection`: (Export) Exports the **selected rows** from a `DataGrid` to a CSV.
    * `ParseAndQueryCsv`, `ParseFullCsvToDataTable`, `EscapeCsvCell`: Helper methods for CSV parsing and formatting.

* **`MainWindow.Plugins.cs`**
    * **Plugin Infrastructure.**
    * Contains the `PluginContext` private inner class.
    * This class implements the `IPluginContext` interface and acts as a safe "proxy" passed to plugins. It allows them to call back to main window functions (like `GetValue`, `SetValue`, `ShowMessage`) without exposing the full `MainWindow` instance.

* **`MainWindow.Helpers.cs`**
    * **Common Helper Methods.**
    * Contains generic helper methods that are shared by **multiple** other `partial` files (like `Data.cs`, `Events.cs`, and `Plugins.cs`).
    * `GetValueFromControl`, `SetValueOnControl`, `SetControlProperty`: Read/write values from/to different types of UI controls.
    * `FindControlByName`: Finds a dynamically registered control within the window.
    * `TryParseColor`: Safely converts a color string (e.g., "#FFF" or "Red") into a `Brush` object.
    * `GetColumnBindingPath`: Gets the binding path from a `DataGrid` column.

## Configuration

* **`app-settings.json`**:
    * This is the only configuration file read on startup.
    * It must contain an `ActiveUiConfigFile` key, whose value is the name of the JSON file to load from the `/ui-configs/` directory.
    ```json
    {
      "ActiveUiConfigFile": "main-config.json"
    }
    ```

* **`/ui-configs/*.json`**:
    * This directory holds all UI definition files. You can create multiple configurations here (e.g., `admin.json`, `user.json`) and switch between them by changing `app-settings.json`.
    * These files define the `window`, `theme`, `layoutDefinition`, `controls`, and `dataImport`/`dataExport` rules.

## Plugin System

* **Location:** Plugins are standard .NET DLLs that must be placed in the `/plugins` folder in the application's root directory.
* **Contract:** The plugin DLL must contain one or more `public` classes that implement the `IDynamicPlugin` interface.
* **Loading:** `MainWindow` automatically loads all valid plugins on startup.
* **Interaction:**
    1.  A `PluginSurface` control can be defined in the JSON, which automatically requests the UI from a specified plugin (`pluginName`) and displays it.
    2.  Buttons or other controls in the JSON can point their `action` to a plugin (via the `pluginOwner` or `actionTarget` property).
    3.  When the action is triggered, `MainWindow` calls that plugin's `HandleAction` method, passing it an `IPluginContext` instance to allow the plugin to perform its logic.